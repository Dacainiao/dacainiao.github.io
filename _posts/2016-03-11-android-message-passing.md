---
layout: post
date: 2016-03-11 14:13:10 +0800
title:  "Android 的消息传递"

---

到目前为止，关于线程间通信的讨论都是在常规的 Java 语言中，在任何一个 Java 应用中都可以见到。由于 Android 应用中 UI 主线程的阻塞倾向，在将管道，共享内存以及阻塞队列这些机制应用于 Android 应用时，会引起很多问题。当在使用具有阻塞行为的机制时，UI 主线程的响应性会受到威胁，并且很有可能导致其被挂起。

在 Android 应用中，最常见的线程间通信发生在 UI 主线程和工作线程之间。因此，Android 平台定义了自己的消息传递机制来达到线程间通信的目的。UI 主线程可以通过将要处理的数据信息发送给后台线程的方式将耗时的任务移交给后台线程处理。该消息传递机制是一种非阻塞的生产者-消费者模式，因此在消息传递期间，生产者线程和消费者线程都不会发生阻塞。

该种机制在 Android 平台中是一种基本的消息处理机制，相关 API 和实现的一系列类位于 **android.os** 包中，见**图4-4**：

![图4-4](/resources/images/figure-4-4.png)

***图4-4***

**android.os.Looper**

&emsp;&emsp;消息的分发者，与有且只有一个消费者线程相联系。

**android.os.Handler**

&emsp;&emsp;消费者线程的消息处理者，并且作为生产者线程向消息队列中插入消息的接口。一个 Looper 可以与多个 Handler 相联系，但是它们插入消息的消息队列是同一个。

**android.os.MessageQueue**

&emsp;&emsp;在消费者线程上处理的消息的无界链表。每一个 Looper 和线程至多拥有一个 MessageQueue.

**android.os.Message**

&emsp;&emsp;消费者线程上执行的的消息类。

生产者线程插入消息以及消费者线程处理消息的过程如**图4-5**所示：

![图4-5](/resources/images/figure-4-5.png)

***图4-5 展示了多个生产者线程与一个消费者线程之间的消息传递***

1. 插入消息：生产者线程通过与消费者线程连接的 Handler 将消息插入消息队列。
2. 取回消息：运行在消费者线程的 Looper 将消息从消息队列中顺序的取出。
3. 分发消息：Handler 负责处理运行在消费者线程的消息。一个线程可以拥有多个用来处理消息的 Handler 实例；Looper 则保证消息能够分发给正确的 Handler。

## 示例：简单的消息传递
